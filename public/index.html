<html>
<!DOCTYPE html>
<head>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>
<body>
  <script src="/primus.js" type="text/javascript" charset="utf-8"></script>
  
  <script type="text/javascript" charset="utf-8">
    var primus = Primus.connect(undefined, { websockets: true, network: true, manual: true, ping: 20000 });
    var project = 'testing';
    var userId = 12345;
    var sessionId = null;
    var userKey = null;
    var authToken = 'abcdef';
    var notificationOffset = null;
    
    var getSessionId = function(callback) {
      if(sessionId) return callback(sessionId);
      
      var matched = document.cookie.match(/session_id=([^ ;]+)/) || [];
      if(matched[1]) {
        sessionId = matched[1];
        callback(sessionId);
      } else {
        primus.id(function(id) {
          sessionId = id;
          document.cookie = 'session_id=' + sessionId + '; max-age=' + 12 * 60 * 60;
          callback(sessionId);
        });
      }
    };
    
    var subscribeTo = function(channel) {
      primus.write({
        action: 'Subscribe',
        params: {
          channel: channel
        }
      });
    };
    
    var createNotification = function(message, url, category) {
      $.post('/notify', {
        user_key: userKey,
        message: message,
        url: url,
        category: category
      });
    }
    
    var getNotifications = function(isUnread) {
      if(!isUnread) isUnread = null;
      
      primus.write({
        action: 'GetNotifications',
        params: {
          limit: 20,
          offset: notificationOffset,
          unread: isUnread
        }
      });
    };
    
    var receivedNotifications = function(notifications) {
      var toMark = notifications.filter(function(notification) {
        return !notification.is_delivered;
      }).map(function(notification) {
        notification.is_delivered = true;
        return notification.id;
      });
      
      if(toMark.length > 0) {
        primus.write({
          action: 'ReadNotifications',
          params: { ids: toMark }
        });
      }
    };
    
    var createAnnouncement = function(message, scope, category) {
      $.post('/announce', {
        message: message,
        scope: scope,
        category: category
      });
    }
    
    var getAnnouncements = function() {
      primus.write({
        action: 'GetAnnouncements',
        params: {
          channels: ['zooniverse', 'projects:' + project]
        }
      });
    };
    
    var receivedAnnouncements = function(announcements) {
      primus.write({
        action: 'ReadAnnouncements',
        params: {
          keys: announcements.map(function(announcement) {
            return announcement.scope + ':' + announcement.id;
          })
        }
      });
    };
    
    var getPresence = function(channel) {
      if(channel) {
        $.get('/active_users', { channel: channel }).then(function(users) {
          console.log(users);
        });
      } else {
        $.get('/presence').then(function(counts) {
          console.log(counts);
        });
      }
    };
    
    primus.on('outgoing::url', function(url) {
      getSessionId(function(id) {
        url.query = 'user_id=' + userId + '&auth_token=' + authToken + '&session_id=' + id;
      });
    });
    
    primus.on('data', function(data) {
      console.log('received ', data);
      
      if(data.type == 'notifications') {
        var lastNotification = data.notifications[data.notifications.length - 1] || { };
        if(lastNotification.created_at) notificationOffset = lastNotification.created_at;
        
        receivedNotifications(data.notifications);
      } else if(data.type == 'announcements') {
        receivedAnnouncements(data.announcements);
      }
    });
    
    primus.on('open', function() {
      subscribeTo('zooniverse');
      subscribeTo('projects:' + project);
      if(userId) {
        userKey = 'user:' + userId;
      } else {
        getSessionId(function(id) {
          userKey = 'session:' + sessionId;
        });
      }
      
      subscribeTo(userKey);
    });
    
    primus.end().open();
  </script>
</body>
</html>
