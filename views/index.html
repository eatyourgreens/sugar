<html>
<!DOCTYPE html>
<head>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>
<body>
  <script src="/primus.js" type="text/javascript" charset="utf-8"></script>
  
  <script type="text/javascript" charset="utf-8">
    var primus = Primus.connect(undefined, { websockets: true, network: true, manual: true, ping: 20000 });
    var project = 'testing';
    var userId = 12345;
    var sessionId = null;
    var authToken = 'abcdef';
    var notificationOffset = null;
    
    var subscribeTo = function(channel) {
      primus.write({
        action: 'Subscribe',
        params: {
          channel: channel
        }
      });
    };
    
    var createNotification = function(message, url, category) {
      $.post('/notify', {
        user_id: userId,
        message: message,
        url: url,
        category: category
      });
    }
    
    var getNotifications = function(isUnread) {
      if(!isUnread) isUnread = null;
      
      var key = userId ? 'user:' + userId : 'session:' + sessionId;
      primus.write({
        action: 'GetNotifications',
        params: {
          limit: 20,
          offset: notificationOffset,
          userId: userId,
          sessionId: sessionId,
          unread: isUnread
        }
      });
    };
    
    var receivedNotifications = function(notifications) {
      var toMark = notifications.filter(function(notification) {
        return !notification.is_delivered;
      }).map(function(notification) {
        notification.is_delivered = true;
        return notification.id;
      });
      
      if(toMark.length > 0) {
        primus.write({
          action: 'ReadNotifications',
          params: { ids: toMark }
        });
      }
    };
    
    var createAnnouncement = function(message, scope, category) {
      $.post('/announce', {
        message: message,
        scope: scope,
        category: category
      });
    }
    
    var getAnnouncements = function() {
      primus.write({
        action: 'GetAnnouncements',
        params: {
          channels: ['zooniverse', 'projects:' + project]
        }
      });
    };
    
    primus.on('outgoing::url', function(url) {
      url.query = 'user_id=' + userId + '&' + 'auth_token=' + authToken;
    });
    
    primus.on('data', function(data) {
      console.log('received ', data);
      
      if(data.type == 'notifications') {
        var lastNotification = data.notifications[data.notifications.length - 1] || { }
        if(lastNotification.created_at) notificationOffset = lastNotification.created_at;
        
        receivedNotifications(data.notifications);
      }
    });
    
    primus.on('open', function() {
      subscribeTo('zooniverse');
      subscribeTo('projects:' + project);
      if(userId) {
        subscribeTo('users:' + userId);
      } else {
        primus.id(function(id) {
          sessionId = id;
          subscribeTo('session:' + id);
        });
      }
    });
    
    primus.end().open();
  </script>
</body>
</html>
